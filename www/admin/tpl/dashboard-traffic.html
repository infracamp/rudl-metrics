<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css">


<template is="ka-tpl" debug auto>
    <script>
        ((self) => {

            function mkledgend(data, key) {
                let ret = {
                    "legend": [],
                    "values": []
                };
                for (let cur of data) {
                    let time = new Date(cur.time);
                    ret.legend.push(time.getHours() + ":" + time.getMinutes());
                    ret.values.push(cur[key]);
                }
                return ret;
            }
            let chartColors = {
                red: 'rgb(255, 99, 132)',
                orange: 'rgb(255, 159, 64)',
                yellow: 'rgb(255, 205, 86)',
                green: 'rgb(75, 192, 192)',
                blue: 'rgb(54, 162, 235)',
                purple: 'rgb(153, 102, 255)',
                grey: 'rgb(201, 203, 207)'
            };
            var elem = document.getElementById("traffic");
            var config = {
                type: "line",
                data: {
                    labels: [],
                    datasets: []
                }
            };
            let datasets = config.data.datasets;
            var chart = new Chart(elem.getContext("2d"), config);



            self.$scope.presets = [
                {
                    name: "Requests",
                    query: `select sum(*) from cloudfront_stats_cluster_min WHERE time > now() - 24h GROUP BY time(15m) fill(0) ORDER BY time DESC `,
                    sensors:[
                        {"label": "Requests total",  "key": "sum_tot.req", "color": chartColors.blue},
                        {"label": "OK200",  "key": "sum_tot.req200", "color": chartColors.green},
                        {"label": "ERR500",  "key": "sum_tot.req500", "color": chartColors.red},
                        {"label": "ERR404",  "key": "sum_tot.req404", "color": chartColors.yellow},
                    ]
                },
                {
                    name: "Traffic",
                    query: `select sum(*) from cloudfront_stats_cluster_min WHERE time > now() - 24h GROUP BY time(15m) fill(0) ORDER BY time DESC `,
                    sensors:[
                        {"label": "Inbound (b)",  "key": "sum_tot.bytesin", "color": chartColors.blue},
                        {"label": "Outbound (b)",  "key": "sum_tot.bytesout", "color": chartColors.green}
                    ]
                },

            ];
            self.$scope.active = self.$scope.presets[0];
            self.$scope.refresh = () => {
                datasets.length = 0;
                ka_http_req("/admin/api/query?q=:query", {"query": self.$scope.active.query}).withDebug().json = (r) => {
                    for (let sensor of self.$scope.active.sensors) {
                        let ld = mkledgend(r.result, sensor.key);
                        datasets.push({
                            label: sensor.label,
                            borderColor: sensor.color,
                            //backgroundColor: sensor.color,
                            data: ld.values
                        });
                        config.data.labels = ld.legend;
                    }
                    chart.update();
                };
            };
            self.$scope.refresh();

        })(KASELF);

    </script>

    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-sm-5">
                    <h4 class="card-title mb-0">{{ active.name }}

                    <div class="btn-group">

                        <button type="button" class="btn btn-lg dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <div class="dropdown-menu">
                            <a *for="let cur of presets" class="dropdown-item" href="#" [on.click]="$scope.active = cur;  $scope.refresh();">{{ cur.name }}</a>
                        </div>
                    </div>
                    </h4>
                    <div class="small text-muted">November 2017</div>
                </div>
                <div class="col-sm-7 d-none d-md-block">
                    <form is="ka-form" onchange="alert(this.$data)">
                    <div class="btn-group btn-group-toggle float-right mr-3" data-toggle="buttons">
                        <label class="btn btn-secondary active">
                            <input type="radio" name="options" id="option1" checked> Day
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="options" id="option2"> Week
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="options" id="option3"> Month
                        </label>
                    </div>
                    </form>
                </div>
            </div>
            <div class="chart-wrapper" style="height:300px;margin-top:40px;">
                <div class="chartjs-size-monitor">
                    <div class="chartjs-size-monitor-expand">
                        <div class=""></div>
                    </div>
                    <div class="chartjs-size-monitor-shrink">
                        <div class=""></div>
                    </div>
                </div>
                <canvas basechart="" class="chart chartjs-render-monitor"
                        style="display: block; width: 1602px; height: 300px;" width="1602" height="300"
                        id="traffic"></canvas>
                <div id="_canvas-1a2b11e837-tooltip" class="chartjs-tooltip center"
                     style="opacity: 0; left: 55.76px; top: 303.554px;">
                    <div class="tooltip-header">
                        <div class="tooltip-header-item">Monday</div>
                    </div>
                    <div class="tooltip-body">
                        <div class="tooltip-body-item"><span class="tooltip-body-item-color"
                                                             style="background-color: rgb(99, 194, 222);"></span><span
                                class="tooltip-body-item-label">Current</span><span
                                class="tooltip-body-item-value">140</span></div>
                        <div class="tooltip-body-item"><span class="tooltip-body-item-color"
                                                             style="background-color: rgb(77, 189, 116);"></span><span
                                class="tooltip-body-item-label">Previous</span><span
                                class="tooltip-body-item-value">98</span></div>
                        <div class="tooltip-body-item"><span class="tooltip-body-item-color"
                                                             style="background-color: rgb(248, 108, 107);"></span><span
                                class="tooltip-body-item-label">BEP</span><span
                                class="tooltip-body-item-value">65</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class="row text-center">
                <div class="col-sm-12 col-md mb-sm-2 mb-0">
                    <div class="text-muted">Visits</div>
                    <strong>29.703 Users (40%)</strong>
                    <div class="progress progress-xs mt-2">
                        <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="40" class="progress-bar bg-success"
                             role="progressbar" style="width: 40%"></div>
                    </div>
                </div>
                <div class="col-sm-12 col-md mb-sm-2 mb-0">
                    <div class="text-muted">Unique</div>
                    <strong>24.093 Users (20%)</strong>
                    <div class="progress progress-xs mt-2">
                        <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="20" class="progress-bar bg-info"
                             role="progressbar" style="width: 20%"></div>
                    </div>
                </div>
                <div class="col-sm-12 col-md mb-sm-2 mb-0">
                    <div class="text-muted">Pageviews</div>
                    <strong>78.706 Views (60%)</strong>
                    <div class="progress progress-xs mt-2">
                        <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="60" class="progress-bar bg-warning"
                             role="progressbar" style="width: 60%"></div>
                    </div>
                </div>
                <div class="col-sm-12 col-md mb-sm-2 mb-0">
                    <div class="text-muted">New Users</div>
                    <strong>22.123 Users (80%)</strong>
                    <div class="progress progress-xs mt-2">
                        <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="80" class="progress-bar bg-danger"
                             role="progressbar" style="width: 80%"></div>
                    </div>
                </div>
                <div class="col-sm-12 col-md mb-sm-2 mb-0">
                    <div class="text-muted">Bounce Rate</div>
                    <strong>40.15%</strong>
                    <div class="progress progress-xs mt-2">
                        <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="40" class="progress-bar"
                             role="progressbar" style="width: 40%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>


<template is="ka-tpl" auto="">

</template>


<div class="row">
    <div class="col-12">


    </div>
</div>

